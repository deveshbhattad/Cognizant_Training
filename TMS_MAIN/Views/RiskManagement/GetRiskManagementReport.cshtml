@* Views/RiskManagement/GetRiskManagementReport.cshtml *@
@model TMS_MAIN.Models.RiskReportViewModel

@{
    ViewData["Title"] = "Risk Management Report";
    Layout = "~/Views/Shared/_TreasurerLayout.cshtml";
}

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=wrap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"></style>
    <link href="~/css/treasurer-dashboard.css" rel="stylesheet" />
    <style>
        @@media print {
            #reportForm { /* to hide the form from printing */
                display: none;
            }
        }
        /* Navbar Styling (retained for consistency) */
        .navbar {
            background-color: #343a40 !important;
        }

        .navbar-brand, .nav-link {
            color: white !important;
        }

        .navbar-title {
            color: white !important;
            font-size: 1.5rem;
            margin-left: 30px;
        }

        /* Adjust top margin for content below fixed navbar */
        .container {
            margin-top: 50px;
        }

        .risk-level-low {
            color: green;
            font-weight: bold;
        }

        .risk-level-medium {
            color: orange;
            font-weight: bold;
        }

        .risk-level-high {
            color: red;
            font-weight: bold;
        }
    </style>
}



<div class="container pt-5">
    <h2 class="text-center my-4">Risk Management Report</h2>

    <div class="card p-4 mb-4 shadow-sm" id="reportForm">
        <form asp-action="GetRiskManagementReport" asp-controller="RiskManagement" method="get">
            @* Changed controller *@
            <div class="row">
                <div class="col-md-5 mb-3">
                    <label class="form-label">Start Date:</label>
                    <input type="date" name="startDate" class="form-control" value="@Model.StartDate.ToString("yyyy-MM-dd")">
                </div>
                <div class="col-md-5 mb-3">
                    <label class="form-label">End Date:</label>
                    <input type="date" name="endDate" class="form-control" value="@Model.EndDate.ToString("yyyy-MM-dd")">
                </div>
                <div class="col-md-2 mb-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100 me-2">Filter</button>
                    <button type="button" onclick="printReport()" class="btn btn-secondary w-100">Print</button>
                </div>
            </div>
        </form>
    </div>

    <div class="card p-4 mb-4 shadow-sm">
        <div class="card-body">
            <h4 class="card-title text-center mb-4">Summary for @Model.StartDate.ToShortDateString() to @Model.EndDate.ToShortDateString()</h4>
            <div class="row text-center">
                <div class="col-md-3">
                    <h5>Total Risks</h5>
                    <p class="h3 text-primary">@Model.TotalRisks</p>
                </div>
                <div class="col-md-3">
                    <h5>Avg. Risk Score</h5>
                    <p class="h3 text-info">@Model.AverageRiskScore.ToString("F2")</p>
                </div>
                <div class="col-md-2">
                    <h5>Critical Risk</h5>
                    <p class="h3 text-warning">@Model.CriticalRiskCount</p>
                </div>
                <div class="col-md-2">
                    <h5>High Risk</h5>
                    <p class="h3 text-danger">@Model.HighRiskCount</p>
                </div>
                <div class="col-md-2">
                    <h5>Medium Risk</h5>
                    <p class="h3 text-warning">@Model.MediumRiskCount</p>
                </div>
                <div class="col-md-2">
                    <h5>Low Risk</h5>
                    <p class="h3 text-success">@Model.LowRiskCount</p>
                </div>
                <div class="col-md-2">
                    <h5>Very Low Risk</h5>
                    <p class="h3 text-danger">@Model.VeryLowRiskCount</p>
                </div>
            </div>
        </div>
    </div>

    <h3 class="mt-4 text-center">Detailed Risk Transactions</h3>
    @if (Model.FilteredRisks != null && Model.FilteredRisks.Any())
    {
        <div class="table-responsive">
            <table class="table table-hover table-bordered shadow-sm">
                <thead class="table-dark">
                    <tr>
                        <th>Risk ID</th>
                        <th>Risk Type</th>
                        <th>Transaction Ref</th>
                        <th>Amount</th> @* NEW *@
                        <th>Impact</th> @* NEW *@
                        <th>Probability</th> @* NEW *@
                        <th>Score</th> @* NEW *@
                        <th>Level</th> @* NEW *@
                        <th>Assessment Date</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var risk in Model.FilteredRisks)
                    {
                        <tr>
                            <td>@risk.RiskId</td>
                            <td>@risk.RiskType</td>
                            <td>@risk.TransactionReference</td>
                            <td>@risk.Amount</td> @* NEW *@
                            <td>@risk.Impact</td> @* NEW *@
                            <td>@risk.Probability</td> @* NEW *@
                            <td>@risk.RiskScore.ToString("F2")</td> @* NEW *@
                            <td class="risk-level-@risk.RiskLevel.ToLower()">@risk.RiskLevel</td> @* NEW *@
                            <td>@risk.AssessmentDate.ToString("yyyy-MM-dd")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center" role="alert">
            No risk records found for the selected date range.
        </div>
    }
    <div class="text-center mt-4">
        <a asp-action="RMIndex" asp-controller="RiskManagement" class="btn btn-dark">Back to Risk Overview</a> @* Changed controller *@
    </div>
</div>

@section Scripts {
    <script>
        function printReport() {
            document.getElementById('reportForm').style.display = 'none';
            window.print();
            setTimeout(() => {
                document.getElementById('reportForm').style.display = 'block';
            }, 500);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="~/js/treasurer-dashboard.js"></script>
}